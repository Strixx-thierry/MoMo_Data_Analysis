<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTN MoMo SMS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
</head>
<style>
    .modal {
        transition: all 0.3s ease;
    }
    .modal.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .modal.hide {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-20px);
    }
    .dropdown-menu {
        transition: all 0.3s ease;
        max-height: 0;
        overflow: hidden;
    }
    .dropdown-menu.open {
        max-height: 300px;
    }
    .transaction-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<body class="bg-gray-100 font-sans">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-indigo-900 text-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <h1 class="text-2xl font-bold">MoMo SMS Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-white text-indigo-900 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-100 transition flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Import Data</span>
                    </button>
                    <div id="loadingIndicator" class="hidden flex items-center space-x-2">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-indigo-500">
                    <h3 class="text-gray-500 text-sm font-medium">Total Transactions</h3>
                    <div class="mt-2 flex justify-between items-end">
                        <p id="total-transactions" class="text-3xl font-bold text-gray-900">0</p>
                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs font-medium">+12%</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                    <h3 class="text-gray-500 text-sm font-medium">Total Amount</h3>
                    <div class="mt-2 flex justify-between items-end">
                        <p id="total-amount" class="text-3xl font-bold text-gray-900">RWF 0</p>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">+8.5%</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
                    <h3 class="text-gray-500 text-sm font-medium">Average Amount</h3>
                    <div class="mt-2 flex justify-between items-end">
                        <p id="avg-amount" class="text-3xl font-bold text-gray-900">RWF 0</p>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">-3.2%</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
                    <h3 class="text-gray-500 text-sm font-medium">Unique Senders</h3>
                    <div class="mt-2 flex justify-between items-end">
                        <p id="unique-senders" class="text-3xl font-bold text-gray-900">0</p>
                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">+5.1%</span>
                    </div>
                </div>
            </div>

            <!-- Charts & Data Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Transaction Types Chart -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-900">Transaction Types Distribution</h2>
                        <div class="relative">
                            <button id="timeRangeBtn" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900">
                                <span class="font-medium">Last 30 days</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="transactionTypeChart"></canvas>
                    </div>
                </div>

                <!-- Transaction Types Breakdown -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Top Senders</h2>
                    <div id="sender-stats" class="space-y-2">
                        <!-- Sender stats will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Recent Transactions and Monthly Trend -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Transaction Types List -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Transaction Types</h2>
                    <ul id="transaction-types" class="space-y-2">
                        <!-- Transaction types will be dynamically added here -->
                    </ul>
                </div>

                <!-- Monthly Trend -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Monthly Breakdown</h2>
                    <ul id="time-stats" class="space-y-2">
                        <!-- Time stats will be dynamically added here -->
                    </ul>
                </div>

                <!-- Status Stats -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Transaction Status</h2>
                    <ul id="status-stats" class="space-y-2">
                        <!-- Status stats will be dynamically added here -->
                    </ul>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-4">
            <div class="container mx-auto px-4 text-center">
                <p>Â© 2024 MTN Rwanda MoMo SMS Dashboard. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        let transactionTypeChart;

        // Function to show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('refreshBtn').disabled = true;
        }

        // Function to hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('refreshBtn').disabled = false;
        }

        // Add file input element to the header
        const headerDiv = document.querySelector('header .container');
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.className = 'hidden';
        fileInput.id = 'jsonFileInput';
        headerDiv.appendChild(fileInput);

        // Modify the refresh button to trigger file input
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.onclick = () => {
            document.getElementById('jsonFileInput').click();
        };

        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showLoading();
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        processData(data);
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        alert('Error loading data. Please make sure the file is valid JSON.');
                    } finally {
                        hideLoading();
                    }
                };
                reader.readAsText(file);
            }
        });

        function processData(data) {
            console.log('Processing data:', data);
            
            // Process transaction data
            const transactions = data.filter(msg => msg.type && msg.amount);
            const totalTransactions = transactions.length;
            const totalAmount = transactions.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            const avgAmount = totalTransactions > 0 ? totalAmount / totalTransactions : 0;

            // Get unique senders
            const uniqueSenders = new Set(transactions.map(t => t.sender).filter(sender => sender)).size;

            // Update summary cards
            document.getElementById('total-transactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('total-amount').textContent = `RWF ${totalAmount.toLocaleString()}`;
            document.getElementById('avg-amount').textContent = `RWF ${Math.round(avgAmount).toLocaleString()}`;
            document.getElementById('unique-senders').textContent = uniqueSenders.toLocaleString();

            // Process sender data
            const senderStats = {};
            transactions.forEach(t => {
                if (t.sender) {
                    senderStats[t.sender] = (senderStats[t.sender] || 0) + (parseFloat(t.amount) || 0);
                }
            });

            // Update sender stats (top 10)
            const senderStatsList = document.getElementById('sender-stats');
            senderStatsList.innerHTML = '';
            Object.entries(senderStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([sender, amount]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1 text-sm';
                    div.innerHTML = `
                        <span class="truncate mr-2">${sender}</span>
                        <span class="font-medium text-green-600">RWF ${amount.toLocaleString()}</span>
                    `;
                    senderStatsList.appendChild(div);
                });

            // Process transaction types
            const typeStats = {};
            transactions.forEach(t => {
                if (t.type) {
                    typeStats[t.type] = (typeStats[t.type] || 0) + 1;
                }
            });

            // Update transaction types
            const typeStatsList = document.getElementById('transaction-types');
            typeStatsList.innerHTML = '';
            Object.entries(typeStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([type, count]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1 text-sm';
                    li.innerHTML = `
                        <span>${type}</span>
                        <span class="font-medium text-indigo-600">${count}</span>
                    `;
                    typeStatsList.appendChild(li);
                });

            // Process time-based data
            const timeStats = {};
            transactions.forEach(t => {
                if (t.raw_date) {
                    const date = new Date(t.raw_date);
                    if (!isNaN(date.getTime())) {
                        const month = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                        timeStats[month] = (timeStats[month] || 0) + (parseFloat(t.amount) || 0);
                    }
                }
            });

            // Update time-based stats
            const timeStatsList = document.getElementById('time-stats');
            timeStatsList.innerHTML = '';
            Object.entries(timeStats)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                .forEach(([month, amount]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1 text-sm';
                    li.innerHTML = `
                        <span>${month}</span>
                        <span class="font-medium text-blue-600">RWF ${amount.toLocaleString()}</span>
                    `;
                    timeStatsList.appendChild(li);
                });

            // Process status data
            const statusStats = {};
            transactions.forEach(t => {
                if (t.status) {
                    statusStats[t.status] = (statusStats[t.status] || 0) + 1;
                }
            });

            // Update status stats
            const statusStatsList = document.getElementById('status-stats');
            statusStatsList.innerHTML = '';
            Object.entries(statusStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([status, count]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1 text-sm';
                    li.innerHTML = `
                        <span>${status}</span>
                        <span class="font-medium text-purple-600">${count}</span>
                    `;
                    statusStatsList.appendChild(li);
                });

            // Update the pie chart
            updateTransactionTypeChart(typeStats);
        }

        function updateTransactionTypeChart(typeStats) {
            const ctx = document.getElementById('transactionTypeChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (transactionTypeChart) {
                transactionTypeChart.destroy();
            }

            const labels = Object.keys(typeStats);
            const data = Object.values(typeStats);
            const colors = [
                '#6366F1', '#10B981', '#F59E0B', '#3B82F6', 
                '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6',
                '#F97316', '#84CC16'
            ];

            transactionTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize the dashboard when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show a message to select the JSON file
            alert('Please click the "Refresh Data" button and select your cleaned_sms_data.json file to load the dashboard.');
        });
    </script>
</body>
</html>